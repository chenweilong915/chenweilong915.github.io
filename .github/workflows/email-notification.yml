name: Email Notification for New Comments

on:
  push:
    paths:
      - '_data/comments/**'
    branches: [ main ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Get latest comment
      id: get-comment
      run: |
        # è·å–æœ€æ–°çš„ç•™è¨€æ–‡ä»¶
        LATEST_COMMENT=$(find _data/comments -name "*.yml" -type f -exec ls -t {} + | head -n 1)
        if [ ! -z "$LATEST_COMMENT" ]; then
          echo "comment-file=$LATEST_COMMENT" >> $GITHUB_OUTPUT
          echo "Found new comment: $LATEST_COMMENT"
        fi

    - name: Parse comment data
      id: parse-comment
      if: steps.get-comment.outputs.comment-file
      run: |
        COMMENT_FILE="${{ steps.get-comment.outputs.comment-file }}"
        if [ -f "$COMMENT_FILE" ]; then
          # è§£æYAMLæ–‡ä»¶è·å–ç•™è¨€ä¿¡æ¯
          NAME=$(grep "name:" "$COMMENT_FILE" | sed 's/name: *//' | tr -d '"')
          EMAIL=$(grep "email:" "$COMMENT_FILE" | sed 's/email: *//' | tr -d '"')
          MESSAGE=$(grep -A 10 "message:" "$COMMENT_FILE" | tail -n +2 | sed 's/^[[:space:]]*//')
          DATE=$(grep "date:" "$COMMENT_FILE" | sed 's/date: *//' | tr -d '"')
          
          echo "commenter-name=$NAME" >> $GITHUB_OUTPUT
          echo "commenter-email=$EMAIL" >> $GITHUB_OUTPUT
          echo "comment-date=$DATE" >> $GITHUB_OUTPUT
          
          # å¤„ç†å¤šè¡Œç•™è¨€å†…å®¹
          echo "comment-message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

    - name: Send email notification
      if: steps.parse-comment.outputs.commenter-name
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸ”” æ–°ç•™è¨€æé†’ / New Comment Notification - é™ˆä¼Ÿé¾™çš„ä¸ªäººç½‘ç«™"
        to: chenweilong921@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          æ‚¨å¥½ï¼æ‚¨çš„ä¸ªäººç½‘ç«™æ”¶åˆ°äº†ä¸€æ¡æ–°ç•™è¨€ï¼š
          
          ğŸ“ ç•™è¨€è€… / Commenter: ${{ steps.parse-comment.outputs.commenter-name }}
          ğŸ“§ é‚®ç®± / Email: ${{ steps.parse-comment.outputs.commenter-email }}
          ğŸ“… æ—¶é—´ / Date: ${{ steps.parse-comment.outputs.comment-date }}
          
          ğŸ’¬ ç•™è¨€å†…å®¹ / Message:
          ${{ steps.parse-comment.outputs.comment-message }}
          
          ---
          
          Hello! You have received a new comment on your personal website:
          
          ğŸ“ Commenter: ${{ steps.parse-comment.outputs.commenter-name }}
          ğŸ“§ Email: ${{ steps.parse-comment.outputs.commenter-email }}
          ğŸ“… Date: ${{ steps.parse-comment.outputs.comment-date }}
          
          ğŸ’¬ Message:
          ${{ steps.parse-comment.outputs.comment-message }}
          
          è¯·è®¿é—®æ‚¨çš„ç½‘ç«™æŸ¥çœ‹å®Œæ•´ç•™è¨€ / Please visit your website to view the complete comment:
          https://chenweilong915.github.io/guestbook/
          
          ---
          æ­¤é‚®ä»¶ç”±GitHub Actionsè‡ªåŠ¨å‘é€ / This email is automatically sent by GitHub Actions
